<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>COBOL Web IDE Multi-fichiers</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.11.0/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
<style>
body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:sans-serif; }
header { display:flex; align-items:center; background:#1e1e1e; color:white; padding:5px 10px; }
header h1 { flex:1; margin:0; font-size:18px; }
#main { display:flex; flex:1; }
#fileList { width:200px; background:#2e2e2e; color:white; padding:10px; box-sizing:border-box; overflow-y:auto; }
#fileList button { display:block; width:100%; margin-bottom:5px; background:#3e3e3e; color:white; border:none; padding:5px; text-align:left; cursor:pointer; }
#fileList button.active { background:#007acc; }
#editorContainer { flex:1; display:flex; flex-direction:column; }
#editor { flex:1; }
#output { height:120px; background:#1e1e1e; color:white; margin:0; padding:10px; overflow-y:auto; }
</style>
</head>
<body>
<header>
<h1>COBOL Web IDE</h1>
<input type="text" id="newFileName" placeholder="Nom fichier.cob" style="width:150px"/>
<button id="newFileBtn">ï¼‹ Fichier</button>
<button id="run">â–¶ Run</button>
<button id="exportProject">ðŸ’¾ Exporter Projet</button>
</header>

<div id="main">
<div id="fileList"></div>
<div id="editorContainer">
<div id="editor"></div>
<pre id="output">Sortie du programmeâ€¦</pre>
</div>
</div>

<script>
require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" } });

require(["vs/editor/editor.main"], function() {
    const files = {};
    let currentFile = null;

    const editor = monaco.editor.create(document.getElementById("editor"), {
        value: "",
        language: "cobol",
        theme: "vs-dark",
        automaticLayout: true
    });

    const fileListContainer = document.getElementById("fileList");
    const output = document.getElementById("output");

    function setActiveButton(name) {
        Array.from(fileListContainer.children).forEach(btn => {
            btn.classList.toggle("active", btn.textContent === name);
        });
    }

    function addFile(name, content) {
        if (files[name]) { alert("Le fichier existe dÃ©jÃ  !"); return; }
        files[name] = content;

        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = () => openFile(name);
        fileListContainer.appendChild(btn);

        if (!currentFile) openFile(name);
    }

    function openFile(name) {
        if (currentFile) files[currentFile] = editor.getValue();
        currentFile = name;
        editor.setValue(files[name]);
        setActiveButton(name);
    }

    // Ajouter fichier
    document.getElementById("newFileBtn").onclick = () => {
        const name = document.getElementById("newFileName").value.trim();
        if (!name) return alert("Entrez un nom de fichier !");
        addFile(name, `IDENTIFICATION DIVISION.\nPROGRAM-ID. ${name.replace(/\..+$/, "").toUpperCase()}.\n\nPROCEDURE DIVISION.\n    DISPLAY "Hello from ${name}".\n    STOP RUN.`);
        document.getElementById("newFileName").value = "";
    };

    // Run
    document.getElementById("run").onclick = () => {
        if (!currentFile) return alert("Aucun fichier ouvert !");
        files[currentFile] = editor.getValue();
        const code = files[currentFile];
        if (!code.includes("IDENTIFICATION DIVISION")) { output.textContent = "âŒ Erreur : IDENTIFICATION DIVISION manquante"; return; }
        const matches = [...code.matchAll(/DISPLAY\s+"([^"]+)"/g)];
        output.textContent = matches.length ? matches.map(m=>m[1]).join("\n") : "(Aucune sortie)";
    };

    // Export ZIP
    document.getElementById("exportProject").addEventListener("click", async () => {
    if (currentFile) files[currentFile] = editor.getValue();

    const zip = new JSZip();
    for (const name in files) zip.file(name, files[name]);

    // GÃ©nÃ©rer un blob directement
    const blob = await zip.generateAsync({ type: "blob" });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "COBOL_Project.zip";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
});

    // Fichier par dÃ©faut
    addFile("HELLO.cob", `IDENTIFICATION DIVISION.
PROGRAM-ID. HELLO.

PROCEDURE DIVISION.
DISPLAY "Hello from COBOL".
STOP RUN.`);
});
</script>
</body>
</html>
