<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>IDE COBOL en ligne</title>
<link rel="stylesheet" href="style.css">
<!-- Monaco Editor CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs/loader.min.js"></script>
<script src="cobol-wasm.js"></script>
</head>
<body>
<h1>IDE COBOL Online</h1>

<div id="tabs">
  <button onclick="switchFile('main.cbl')">main.cbl</button>
  <button onclick="switchFile('utils.cpy')">utils.cpy</button>
</div>

<div id="editor" style="height:400px;border:1px solid #ccc;"></div>

<button onclick="run()">Run</button>
<pre id="console"></pre>

<script>
let files = {
  "main.cbl": document.getElementById('editor').dataset.main || `IDENTIFICATION DIVISION.
PROGRAM-ID. MAIN.
ENVIRONMENT DIVISION.
DATA DIVISION.
PROCEDURE DIVISION.
COPY 'utils.cpy'.
DISPLAY 'Programme COBOL démarré'.
STOP RUN.`,
  "utils.cpy": `IDENTIFICATION DIVISION.
PROGRAM-ID. UTILS.
PROCEDURE DIVISION.
DISPLAY 'Hello depuis utils.cpy'.
EXIT.`
};

let currentFile = 'main.cbl';
let editor;

// Initialisation Monaco
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
  editor = monaco.editor.create(document.getElementById('editor'), {
    value: files[currentFile],
    language: 'plaintext',
    theme: 'vs-light'
  });
});

function switchFile(filename) {
  files[currentFile] = editor.getValue();
  currentFile = filename;
  editor.setValue(files[currentFile]);
}

function run() {
  files[currentFile] = editor.getValue();
  document.getElementById('console').textContent = "";
  
  // Copier tous les fichiers dans le FS virtuel du WASM
  for (let fname in files) {
    FS.writeFile(fname, files[fname]);
  }

  // Exécution du programme principal
  try {
    TinyCOBOL.run(files['main.cbl'], {
      stdout: text => document.getElementById('console').textContent += text + "\n",
      stderr: text => document.getElementById('console').textContent += "ERR: " + text + "\n",
      stdin: () => prompt("Input:")
    });
  } catch(e) {
    document.getElementById('console').textContent += "Erreur: " + e;
  }
}
</script>
</body>
</html>
